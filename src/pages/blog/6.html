[template]
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Glotitude HQ. Ctchi. День шестой</title>

    <link href="/static/css/main.css" type="text/css" rel="stylesheet">
</head>
<body>

<div class="title"><h3>Glotitude HQ</h3></div>

[import "header.html"/]

<div class="content">
    <h4 class="article_title">Ctchi. День шестой</h4>

    <p>
        <b>UPD:</b> выводы сделанные в статье ниже не верны. Для правильных читай следующую статью :)
    </p>


    <p>
        Прошла уже неделя, а мой сайт всё ещё не открывается на домене. Я решил что пора с этим разобраться.
    </p>

    <p>
        Было +- очевидно, что проблема в районе заголовков ответа. Надо было понять чего не хватает, чтобы браузер
        корректно открывал страницу. Chrome просто показывал упавший запрос. FF умудрялся получить его, показать в дев
        тулзах корректный ответ, а дальше рисовал ошибку, что сервер разорвал соединение. Это особенно смущало меня,
        потому что на 127.0.0.1 всё отлично открывалось.
    </p>

    <p>
        Первым делом я прописал в /etc/hosts внешний домен для loopback и воспроизвёл ошибку. Страница всё ещё не рисовалась,
        при этом приложение не падало, тред тоже экстренно не завершался, запись в поток возвращала успех. Пришло время
        вернуться к RFC и посмотреть что же там за заголовки.
    </p>

    <p>
        Чтение спецификации по запросу оказалось на удивление простым занятием, поэтому меня не пугала идея возвращения
        в доку (честно, после Rust вообще не многое пугает :) ). Секция с заголовками не перечисляла ничего обязательного.
        А вот секция 7.2.2 <a href="https://tools.ietf.org/html/rfc2616#section-7.2.2">Entity Length</a> утверждала что
        браузер должен обязательно получить длину сообщения. Хм. Это я могу. Добавляем Content-Length в ответ и вуаля.
    </p>

    <p>
        <code>
            <pre>
                let response = format!(
                    "HTTP/1.1 200 OK\r\nContent-Length: {}\r\n\r\n{}",
                    content.as_bytes().len(),
                    content
                );
            </pre>
        </code>
    </p>

    <p>
        Еееей, сайт открывается по домену. Да, там есть дополнительные сложности в случае сжатого контента и целая глава
        <a href="https://tools.ietf.org/html/rfc2616#section-4.4">Message Length</a>, про то как он считается. Но мы же
        делаем MVP, так что пойдёт и так :) Самое интересное, что когда я нашёл причину, у меня возникло ощущение дежавю,
        как будто я уже сталкивался с этой проблемой и решал её.
    </p>

    <p class="signature">
        by Glotitude 2020.05.16
    </p>

</div>

<div class="footer">
    Glotitude © 2020
</div>
</body>
</html>
[endtemplate]