<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Glotitude HQ. Ctchi. День пятый</title>

    <link href="/static/css/main.css" type="text/css" rel="stylesheet">
</head>
<body>

<div class="title"><h3>Glotitude HQ</h3></div>

<div class="header">
    <a href="/">Home</a>
    <a href="/blog">Блог</a>
</div>

<div class="content">
    <h4 class="article_title">Ctchi. День пятый</h4>

    <p>
        Я пропустил несколько дней в блоге, но это не значит, что я забил на Rust. Я провёл их в попытках придумать
        более удобную реализацию макроса. Я думаю мы все согласимся - конструкция ниже не сильно упрощает код.
    </p>

    <p>
        <code>
            <pre>
                #[static_page("/", "index.html")]
                fn index() -> Route {}

                #[static_page("/blog", "blog.html")]
                fn blog() -> Route {}

                #[static_page("/blog/1", "blog/first_day.html")]
                fn blog1() -> Route {}

                #[static_page("/blog/2", "blog/second_day.html")]
                fn blog2() -> Route {}

                #[static_page("/blog/3", "blog/third_day.html")]
                fn blog3() -> Route {}

                #[static_page("/blog/4", "blog/forth_day.html")]
                fn blog4() -> Route {}
            </pre>
        </code>
    </p>

    <p>
        Сразу виден простор для улучшения: можно сделать универсальную ссылку /blog/{id}/ и одну функцию, которая умеет
        доставать правильную статью в зависимости от параметра. Проблема в том, что Rust статически типизирован и я не
        могу хранить в одном списке методы с разными сигнатурами, а количество параметров напрямую влияет на неё. Я
        стараюсь не подсматривать решения в других проектах, но в данном случае я посмотрел на документацию rocket и
        actix-web (только на само создание приложения), чтобы понять как они могли обойти это ограничение. Первые
        используют макрос routes, которые видимо приводит функции к нужному виду (это спекуляция, я специально не лез в
        код), вторые всегда используют один параметр, но он дженерефицирован. Мне больше нравится первый путь, поэтому
        я пару дней рассуждал на тему: как к нему прийти. Не найдя очевидного ответа, я решил ненадолго переключится
        на другую задачу.
    </p>

    <p>
        Внешний файл с конфигурацией. Я давно его хотел, менять код каждый раз когда ты деплоишь сайт после локального
        тестирования утомительно, намного проще создать локально один конфиг, на сервере другой и заставить программу
        брать параметры из него. И тут я в очередной раз столкнулся с временем жизни.
    </p>

    <p>
        Изначально в структуре Config хранились ссылки на строки (&str), в результате, когда я в функции парсинга
        создавал строку, а потом передавал её в структуру, то я получал dangling pointer, потому что сама строка умирала
        в конце метода, а ссылку получала статическое время жизни. Когда же я использовал String, я в какой-то момент
        получал partially moved объект. Я не нашёл способа заставить объект жить так же долго как и ссылка на него (я
        всё ещё негодую что иммутабельный &str не умеет копироваться, строки - это всегда сложное архитектурное решение
        в ЯП, и я не уверене что в Rust они сделаны лучшим из возможных способов), поэтому я переписал структуру на
        String, убрал 'static и поправил ошибку с передачей владения.
    </p>

    <p>
        Смотрите какая красота получилась.
    </p>

    <p>
        <code>
            <pre>
                // было
                let configuration = Config {
                    bind_path: "127.0.0.1:8080",
                    base_path: "/home/ltoshchev/programming/rust/glotitude_hq/src/static/",
                    static_uri_pref: "/css/",
                };

                // стало
                // он там в кишках ещё и путь к html умеет сам находить
                let configuration = Config::new();
            </pre>
        </code>
    </p>

    <p>
        Хорошо, что я теперь могу не менять конфиги при деплое. Плохо, что мне потребовалось столько времени на
        реализацию тривиальной функциональности :( О, точно, не помню писал ли, но теперь у меня отдаётся 404, если я не
        нашёл страницу ^_^.
    </p>

    <p class="signature">
        by Glotitude 2020.05.15
    </p>

</div>

<div class="footer">
    Glotitude © 2020
</div>
</body>
</html>